# 基于Spring Cloud和PyWPS + PyQGIS的分布式在线地理信息服务

本项目通过使用Spring Cloud配合pyWPS搭建集群，实现发布一个分布式的在线地理信息处理的在线云服务（分布式WPS服务）。

## 1，架构概述

整体架构图如下：

![image-20240605144808693](https://swsk33-note.oss-cn-shanghai.aliyuncs.com/image-20240605144808693.png)

上图中每个部分都是一个单独的节点，分别如下：

- `Consul`是服务注册中心节点，它能够使多个服务模块集群注册到该注册中心，并提供服务发现功能
- `Gateway`是网关节点，位于最外层接收全部用户的请求，在接收到请求后，它能够从注册中心获取已注册服务的集群信息，包括一个集群中所有节点，然后再通过线性轮询的方式实现负载均衡，将用户请求平摊转发至一个集群的不同节点上
- 一个服务调用模块服务和一个`pyWPS`服务共同构成一个节点（后面将这两者整体称作一个**调用器节点**），每个调用器节点中：
	- 服务调用模块使用Spring Boot开发，负责接收符合OGC WPS标准的请求，并将请求转发至它对应的`pyWPS`节点上
	- 而`pyWPS`服务则负责接收服务调用模块的请求，并调用对应的QGIS算子完成处理任务，每个`pyWPS`服务都包含了完整的、全部QGIS算子
	- 当调用器节点启动时，会自动地将自己注册到Consul注册中心中去
	- 可部署多个调用器节点构成一个集群


## 2，调用示例

目前网关暴露的接口如下：

- `/api/executor` POST类型，接收符合OGC WPS规范的请求

实验环境部署的所有节点信息如下：

| Docker容器名称 | 服务                                                  | 地址                    | 端口 |
| -------------- | ----------------------------------------------------- | ----------------------- | ---- |
| consul         | Consul注册中心                                        | 202.114.148.161（内网） | 8500 |
| gateway        | Spring Cloud Gateway节点                              | 127.0.0.1               | 9000 |
| executor-1     | 调用器集群节点-1（Spring Boot调用器模块+`pyWPS`服务） | 127.0.0.1               | 8001 |
| executor-2     | 调用器集群节点-2（Spring Boot调用器模块+`pyWPS`服务） | 127.0.0.1               | 8002 |
| executor-3     | 调用器集群节点-3（Spring Boot调用器模块+`pyWPS`服务） | 127.0.0.1               | 8003 |

上述三个`executor-n`构成一个完整集群。

### (1) 服务注册

当上述所有服务启动时，它们会自动地注册到Consul注册中心，无需我们手动注册，可以在Consul控制台页面（浏览器访问`202.114.148.161:8500`）查看全部已注册服务：

![image-20240606105106341](https://swsk33-note.oss-cn-shanghai.aliyuncs.com/image-20240606105106341.png)

进入服务，我们就可以看到一个集群中全部节点信息：

![image-20240606105134191](https://swsk33-note.oss-cn-shanghai.aliyuncs.com/image-20240606105134191.png)

### (2) 调用服务

用户需要使用符合OGC WPS标准的HTTP请求，来调用对应的算子，只需向网关发送POST请求，地址：`127.0.0.1:9000/api/executor`，请求体内容示例：

```json
{
	"identifier": "native:buffer",
	"inputs": {
		"INPUT": {
			"type": "reference",
			"href": "http://127.0.0.1:5000/static/data/point.zip"
		}
	}
}
```

该请求调用了一个创建缓冲区的算子，并全部使用默认参数，具体数据通过指定文件URL直链的方式传递。

若算子正常执行，则会得到算子执行结果作为响应：

```json
{
	"status": {
		"status": "succeeded",
		"time": "2024-06-06T14:25:42Z",
		"percent_done": "100",
		"message": "PyWPS Process Buffer finished"
	},
	"outputs": {
		"OUTPUT": "<![CDATA[http://localhost:5000/outputs/native-buffer-output-f4ef8bf8-7152-436a-a2eb-120e341c68e2.zip]]>"
	}
}
```

每个`pyWPS`都会发布全部的QGIS算子，也就是说每个调用器节点都发布的是完整的WPS服务，用户通过WPS规范的请求调用时，使用`identifier`字段即可指定需要调用的算子。调研之前也可以通过对应的API查看所有算子或者一个算子的详细信息来查看对应算子的参数结构。

这里使用`12`个线程，每个线程发起`3`次请求模拟并发访问，那么网关则会将所有请求平摊到上述三个不同的调用器节点上去，实现负载均衡。

## 3，Spring Cloud相关简介

Spring Cloud提供了一个完整的分布式微服务解决方案和实现，除了第一代实现Spring Cloud Netflix之外，还有成熟的第二代实现Spring Cloud Alibaba，当然Spring Cloud本身也在后续提供了一些组件的实现。

本项目所使用的相关组件如下。

### (1) Consul注册中心

在分布式微服务中，所有的模块不再全部写在一个项目中，一个大型应用可能被拆分成多个模块并部署至不同的服务器节点上，这就需要面临下列问题：

- 远程调用：模块之间存在依赖时，需要远程调用
- 集群部署：同一个功能模块可以部署成集群，即有多个节点构成

如果没有注册中心，那么服务之间只能直接进行调用：

![](https://swsk33-note.oss-cn-shanghai.aliyuncs.com/image-20220312225248419.png)

这样如果服务地址发生变化，或者临时增加、减少节点，那么就需要修改每个服务代码或者配置。

因此引入注册中心，让每个服务都把自己注册进去，调用时要从注册中心去找服务：

![](https://swsk33-note.oss-cn-shanghai.aliyuncs.com/image-20220312225536773.png)

Consul是一个由Go语言开发的、高性能的分布式网络服务，常常作为我们的服务注册和发现中心使用，作为注册中心使用简单，性能好，并且支持多种语言开发的微服务进行注册，占用资源也很小。

上图中，每一个服务都代表着**一个完整的后端应用程序，或者多个后端程序构成的集群**，只不过在分布式微服务中，通常按照一个应用程序的功能，将每个功能作为一个单独的Spring Boot模块进行开发和部署，且一个功能可以以单节点或者集群形式部署。除此之外，Consul支持不限制的服务数量进行注册，但是不支持对服务进行分类，也因此我们通常需要按照规范配置每个服务的名称，增强可读性。

虽然Consul支持多种语言开发的后端服务进行注册，但是由于Python的分布式微服务生态并不是很全面，想要实现服务发现和负载均衡较为困难，因此在本架构中，仅使用Python搭建`pyWPS`服务调用pyQGIS算子，而服务注册、服务发现、负载均衡等功能，都使用Java的Spring Cloud相关组件完成开发。

### (2) Spring Cloud Gateway

当我们部署了多个服务集群之后，用户需要知道每一个服务的地址才能够进行调用，因此**网关**在微服务中也是非常重要的。

使用Spring Cloud Gateway，用户（前端）的请求只需全部交给Gateway即可，Gateway会根据我们设定的条件判断这个请求转发到哪个微服务上，除此之外Gateway还可以去服务注册中心去寻找服务并转发给目标服务。

![](https://swsk33-note.oss-cn-shanghai.aliyuncs.com/image-20220411213209809.png)

Spring Cloud Gateway默认集成了Spring Cloud LoadBalancer组件实现负载均衡，且默认使用线性轮询策略，我们可以通过自己实现`ReactorServiceInstanceLoadBalancer`接口，并将其作为Bean注入IoC容器，来实现自定义负载均衡策略。

## 4，PyWPS与PyQGIS相关简介

**PyWPS**是OGC Web处理服务(**OGC** **WPS**)标准的服务器端实现，使用**Python**编程语言。

官方文档地址：https://pywps.readthedocs.io/en/latest/index.html

使用PyWPS服务端，需要结合python web框架使用，结合官方案例，选择使用flask框架，利用该框架创建API接口，方便用户直接调用PyWPS服务。大致流程如下图所示：

![image-20240510145224459](https://dg-typora.oss-cn-chengdu.aliyuncs.com/image-20240510145224459.png)

当process注册进去之后，在这里PyWPS服务中，会进行process的处理，如：转成对应的PyWPS描述标准信息；当用户调用该算子时，会进行输入文件的校验、算子的执行、输出文件结果等。只要成功注入了process，PyWPS会自动进行一些操作的处理。

在QGIS中提供了很多的开源算子，故将PyQGIS中的开源算子转为PyWPS中process，实现地理数据的在线处理。

![image-20240510162158505](https://dg-typora.oss-cn-chengdu.aliyuncs.com/image-20240510162158505.png)